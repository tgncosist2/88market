<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.sist.admin.DAO.AdminEventDAO">
	<!-- 두 개의 파라미터를 전달하기 위해 Map 사용 -->
	<select id="selectAllEvent" resultType="kr.co.sist.DTO.EventDTO" parameterType="map">
	    SELECT *
	    FROM (
	        SELECT ROWNUM rn, A.*
	        FROM (
	            SELECT * 
	            FROM EVENT 
	           <where>
	              <if test="esDTO.searchType == 'title' and esDTO.keyword != null and esDTO.keyword != ''">
	                AND title LIKE '%' || #{esDTO.keyword} || '%'
	              </if>
	              <if test="esDTO.searchType == 'content' and esDTO.keyword != null and esDTO.keyword != ''">
	                AND content LIKE '%' || #{esDTO.keyword} || '%'
	              </if>
	              <if test="esDTO.searchType == 'name' and esDTO.keyword != null and esDTO.keyword != ''">
	                AND name LIKE '%' || #{esDTO.keyword} || '%'
	              </if>
	            </where>
	            ORDER BY evt_num DESC
	        ) A
	        WHERE ROWNUM &lt;= #{pagination.endRow}
	    )
	    WHERE rn &gt; #{pagination.startRow}
	</select>

	<!-- 모든 이미지 -->
	<select id="selectAllImage" resultType="kr.co.sist.DTO.ImageDTO" parameterType="int">
		SELECT * FROM IMAGE WHERE IMG_NUM = #{imgNum}
	</select>
	
	<!-- 전체 개수 조회 쿼리 -->
	<select id="selectTotalCount" resultType="int" parameterType="map">
	    SELECT COUNT(*) FROM EVENT
	    <where>
	        <if test="esDTO.searchType == 'title' and esDTO.keyword != null and esDTO.keyword != ''">
	            AND title LIKE '%' || #{esDTO.keyword} || '%'
	        </if>
	        <if test="esDTO.searchType == 'content' and esDTO.keyword != null and esDTO.keyword != ''">
	            AND content LIKE '%' || #{esDTO.keyword} || '%'
	        </if>
	        <if test="esDTO.searchType == 'name' and esDTO.keyword != null and esDTO.keyword != ''">
	            AND name LIKE '%' || #{esDTO.keyword} || '%'
	        </if>
	    </where>
	</select>
	
	<!-- 1. 이벤트 등록 후 생성된 evtNum 리턴 -->
	<insert id="insertEvent" parameterType="kr.co.sist.DTO.EventDTO">
		<selectKey keyProperty="evtNum" resultType="int" order="BEFORE">
			SELECT SEQ_EVT_NUM.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO EVENT (EVT_NUM, TITLE, CONTENT, NAME, START_DATE, END_DATE, EVT_TYPE, ADM_NUM, MAIN_TYPE)
		VALUES (#{evtNum}, #{title}, #{content}, #{name}, #{startDate}, #{endDate}, #{evtType}, #{admNum}, #{mainType})
	</insert>
	
	<!-- 2. 이미지 정보 등록 (썸네일은 메인이미지에, 메인이미지는 SUB_IMAGE1에) -->
	<insert id="insertImage" parameterType="map" useGeneratedKeys="true" keyProperty="imgNum">
		<selectKey keyProperty="imgNum" resultType="int" order="BEFORE">
			SELECT SEQ_IMG_NUM.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO IMAGE (IMG_NUM, MAIN_IMAGE, SUB_IMAGE1, IMAGE_TYPE)
		VALUES (#{imgNum}, #{thumbnailPath}, #{mainImagePath}, #{imageType})
	</insert>
	
	<!-- 3. 이벤트 테이블의 imgNum 업데이트 -->
	<update id="updateEventImgNum" parameterType="map">
		UPDATE EVENT 
		SET IMG_NUM = #{imgNum}
		WHERE EVT_NUM = #{evtNum}
	</update>
</mapper>
