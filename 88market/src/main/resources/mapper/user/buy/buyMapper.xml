<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.sist.user.DAO.BuyDAO">
    <!-- 상품 정보 조회 -->
    <select id="selectProduct" resultType="kr.co.sist.DTO.ProductDTO" parameterType="String">
        SELECT * FROM PRODUCT WHERE PRD_NUM = #{prdNum}
    </select>

    <!-- 상품 이미지 조회 -->
    <select id="selectImage" resultType="kr.co.sist.DTO.ImageDTO" parameterType="int">
        SELECT * FROM IMAGE WHERE IMG_NUM = #{imgNum}
    </select>
    
    <!-- 유저넘버로 배송지 조회 -->
    <select id="selectAddressByUserNum" parameterType="String" resultType="kr.co.sist.DTO.AddressDTO">
    	SELECT * FROM ADDRESS WHERE USER_NUM = #{userNum}
    	ORDER BY ADDR_TYPE DESC
    </select>
    
    <!-- #. 구매 결제 쿼리 -->
    <!-- #-1. PRODUCT 테이블에 APPOINT_TYPE 값 'Y' 변경 -->
    <update id="updateProductAppointType" parameterType="String">
    	UPDATE PRODUCT SET APPOINT_TYPE = 'Y' WHERE PRD_NUM = #{prdNum}
    </update>
    
    <!-- #-2. TRADES 테이블에 INSERT -->
    <insert id="insertProductTrades" parameterType="kr.co.sist.DTO.TradesDTO">
    	<selectKey keyProperty="tradeId" resultType="int" order="BEFORE">
			SELECT SEQ_TRD_NUM.NEXTVAL FROM DUAL
		</selectKey>
    	INSERT INTO TRADES (TRADE_ID, BUYER_ID, SELLER_ID, DELIVERY_NUM, PRD_NUM)
    	VALUES(#{tradeId}, #{buyerId}, '15', #{deliveryNum}, #{prdNum})
    </insert>
    
    <!-- #-3. PAYMENTS 테이블에 INSERT -->
    <insert id="insertProductPayments" parameterType="kr.co.sist.DTO.PaymentsDTO">
    	INSERT INTO PAYMENTS (PAYMENT_UID, AMOUNT, METHOD, CARD_COMPANY, TRADE_ID)
    	VALUES(#{paymentUid}, #{amount}, #{method}, #{cardCompany}, #{tradeId})
    </insert>
    
    <!-- 민경 - 구입목록가져오기 -->
	<resultMap id="purchaseDTOResultMap" type="kr.co.sist.DTO.PurchaseDTO">
	    
	    <!-- TradesDTO 매핑 -->
	    <association property="tradesDTO" javaType="kr.co.sist.DTO.TradesDTO">
	      <id      property="tradeId"     column="trade_id"/>
	      <result  property="buyerId"     column="buyer_id"/>
	      <result  property="sellerId"    column="seller_id"/>
	      <result  property="tradeStatus" column="trade_status"/>
	      <result  property="tradeDate"   column="trade_date"/>
	      <result  property="deliveryNum" column="delivery_num"/>
	      <result  property="prdNum"      column="prd_num"/>
	    </association>
	    
	    <!-- ProductDTO 매핑 -->
	    <association property="productDTO" javaType="kr.co.sist.DTO.ProductDTO">
	      <result property="prdNum"      column="prd_num"/>
	      <result property="title"       column="title"/>
	      <result property="price"       column="price"/>
	      <result property="location1"   column="location1"/>
	      <result property="inputDate"   column="input_date"/>
	      <result property="appointType" column="appoint_type"/>
	      <result property="hiddenType"  column="hidden_type"/>
	      <result property="sellType"    column="sell_type"/>
	      <result property="imgNum"      column="img_num"/>
	    </association>
	    
	    <!-- PaymentsDTO 매핑 -->
	    <association property="paymentDTO" javaType="kr.co.sist.DTO.PaymentsDTO">
	      <result property="paymentUid"  column="payment_uid"/>
	      <result property="amount"      column="amount"/>
	      <result property="method"      column="method"/>
	      <result property="cardCompany" column="card_company"/>
	      <result property="tradeId"     column="trade_id"/>
	    </association>
	    
	</resultMap>

	<!-- 구매 내역 조회 쿼리 -->
	<select id="selectPurchaseHistory" parameterType="String" resultMap="purchaseDTOResultMap">
	  SELECT
	    t.trade_id, t.buyer_id, t.seller_id, t.trade_status, t.trade_date, t.delivery_num, t.prd_num,
	    p.amount, p.payment_uid, p.method, p.card_company,
	    prd.title, prd.price, prd.location1, prd.input_date, prd.appoint_type, prd.hidden_type, prd.sell_type, prd.img_num
	  FROM TRADES t
	  LEFT JOIN PAYMENTS p ON t.trade_id = p.trade_id
	  LEFT JOIN PRODUCT prd ON t.prd_num = prd.prd_num
	  WHERE t.buyer_id = #{buyerId}
	  ORDER BY t.trade_date DESC
	</select>


    
</mapper>
