<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>88마켓 - 판매등록</title>
  <link rel="stylesheet" th:href="@{/css/user/sell.css}" />
  <th:block th:replace="~{components/user/external :: external}"></th:block>
</head>
<body>
  <th:block th:insert="~{components/user/header :: header}"></th:block>

  <main class="product-registration-container">
    <form method="post" th:action="@{/product/sell}" enctype="multipart/form-data">
      <div class="image-upload-section">
        <div class="upload-box">
          <label for="image-upload-input" class="upload-label">
            <img src="/images/upload.png" alt="이미지 업로드" />
          </label>
          <input type="file" name="images" id="image-upload-input" accept="image/*" multiple style="display: none;" />
          <div class="image-count-box"><span id="image-count">0/5</span></div>
        </div>
        <div id="image-preview-box" class="image-preview-box"></div>
      </div>

      <div class="form-section">
        <div class="input-group">
          <input type="text" id="product-name" name="prd_name" placeholder="상품명을 입력해주세요." required />
        </div>

        <!-- 카테고리 선택 -->
        <div class="input-group">
          <p style="margin: 0 0 5px;">카테고리</p>
          <ul class="category-list" id="categoryList">
			  <th:block th:each="cat : ${categoryList}">
			    <li class="category-item" th:data-cat-num="${cat.cat_num}" th:text="${cat.name}"></li>
			  </th:block>
			</ul>
          <input type="hidden" name="catNum" id="catNum" required />
          <p id="category-error" class="error-msg" style="display: none;">카테고리를 선택해주세요.</p>
        </div>

        <div class="input-group">
          <input type="text" id="price" name="prd_price" placeholder="판매가격을 입력해주세요." required />
          <div class="safe-trade-option">
            <input type="checkbox" id="safe-trade" name="prd_safe" />
            <label for="safe-trade">안전거래</label>
          </div>
        </div>

        <div class="input-group">
          <textarea id="product-description" name="prd_detail" placeholder="상품 설명을 입력해주세요." required></textarea>
        </div>

        <div class="trade-method-section">
          <p>거래방법</p>
          <div class="trade-option">
            <input type="checkbox" id="delivery" name="prd_delivery" />
            <label for="delivery">택배거래</label>
          </div>
          <div class="trade-option">
            <input type="checkbox" id="direct-deal" name="prd_direct" />
            <label for="direct-deal">직거래</label>
          </div>
          <p id="trade-method-error" class="error-msg" style="display: none;">거래방법을 하나 이상 선택해주세요.</p>
        </div>
      </div>

      <div class="agreement-section">
        <input type="checkbox" id="info-agreement" required />
        <label for="info-agreement">판매 정보가 실제 상품과 다를 경우, 책임은 판매자에게 있음을 동의합니다.</label>
      </div>
      <button type="submit" class="submit-button">판매하기</button>
    </form>
  </main>

  <th:block th:insert="~{components/user/footer :: footer}"></th:block>

  <script>
    $(function () {
      let imageFiles = [];

      // 이미지 업로드
      $("#image-upload-input").on("change", function (e) {
        const newFiles = Array.from(e.target.files);
        if (imageFiles.length + newFiles.length > 5) {
          alert("최대 5장까지 등록할 수 있습니다.");
          return;
        }
        imageFiles = imageFiles.concat(newFiles);
        updatePreview();
      });

      $(document).on("click", ".delete-image", function () {
        const idx = $(this).data("index");
        imageFiles.splice(idx, 1);
        updatePreview();
      });

      function updatePreview() {
        const previewBox = $("#image-preview-box").empty();
        $("#image-count").text(`${imageFiles.length}/5`);

        const fileReaders = imageFiles.map((file, i) => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function (e) {
              resolve({ index: i, src: e.target.result });
            };
            reader.readAsDataURL(file);
          });
        });

        Promise.all(fileReaders).then((results) => {
          results.forEach((res, i) => {
            const wrapper = $("<div>").addClass("image-wrapper");
            const img = $("<img>").addClass("preview-image").attr("src", res.src);
            const x = $("<div>").addClass("delete-image").text("×").attr("data-index", res.index);
            if (i === 0) wrapper.css("border", "2px solid #7fd0f4");
            wrapper.append(img).append(x);
            previewBox.append(wrapper);
          });
        });
      }

      // 카테고리 선택
      $(document).on("click", ".category-item", function () {
		  $(".category-item").removeClass("active");
		  $(this).addClass("active");
		  $("#catNum").val($(this).data("cat-num"));
		  $("#category-error").hide();
		});

      // 거래방식 + 카테고리 검증
      $("form").on("submit", function (e) {
        const isDeliveryChecked = $("#delivery").is(":checked");
        const isDirectChecked = $("#direct-deal").is(":checked");
        const catNumVal = $("#catNum").val();

        const $tradeError = $("#trade-method-error");
        const $catError = $("#category-error");

        let valid = true;

        if (!isDeliveryChecked && !isDirectChecked) {
          $tradeError.show();
          valid = false;
        } else {
          $tradeError.hide();
        }

        if (!catNumVal) {
          $catError.show();
          valid = false;
        } else {
          $catError.hide();
        }

        if (!valid) {
          e.preventDefault();
          return false;
        }
      });
    });
  </script>
</body>
</html>