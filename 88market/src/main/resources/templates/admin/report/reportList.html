<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 - 신고 관리</title>
  
  <link rel="stylesheet" th:href="@{/css/admin/report/report.css}">
  <link rel="stylesheet" th:href="@{/css/admin/style.css}">
  <link rel="stylesheet" th:href="@{/css/admin/pageTitle.css}">
  <th:block th:replace="~{components/admin/external :: external}"></th:block>
</head>

<body>
  <div th:replace="~{fragments/admin/admin_sidebar :: sidebar}"></div>
  <div th:replace="~{fragments/admin/admin_header :: header}"></div>
  
  <div class="admin-wrapper">
    <div class="main-content">
      <th:block th:replace="~{fragments/admin/admin_pageTitle :: pageTitle('신고 관리','목록')}" />

      <main class="container">
        <section class="search-section">
          <form id="searchForm" th:action="@{/admin/report}" method="get">
            <div class="search-box">
              <select class="search-filter" name="searchType">
                <option value="title" th:selected="${param.searchType == 'title'}">제목</option>
                <option value="content" th:selected="${param.searchType == 'content'}">내용</option>
                <option value="name" th:selected="${param.searchType == 'name'}">신고자</option>
              </select>
              <input type="text" class="search-input" name="keyword" th:value="${param.keyword}" placeholder="검색">
              <button type="submit" class="search-button">검색</button>
              <button type="button" class="search-button" id="resetSearch">초기화</button>
            </div>
          </form>
        </section>

        <section class="report-section">
          <table class="report-table">
            <thead>
              <tr>
                <th><input type="checkbox" class="all-checkbox"></th>
                <th>번호</th>
                <th>제목</th>
                <th>신고자</th>
                <th>신고 대상</th>
                <th>신고일</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="item, i : ${reportList}" class="table-row">
                <td><input type="checkbox" class="checkbox" th:data-report-num="${item.repNum}"></td>
                <td th:text="${pagination.totalCount - ((pagination.pageNum - 1) * pagination.pageSize) - (i.count - 1)}">1</td>
                <td class="report-title" th:text="${item.title}" style="cursor: pointer; text-align: center;"
                 th:onclick="|location.href='@{/admin/report/detail(repNum=${item.repNum})}'|"></td>
                <td th:text="${item.name}">신고자</td>
                <td>
                  <span th:text="${item.reportType == 1 ? '판매자' : '상품'}">판매자</span>
                </td>
                <td th:text="${#dates.format(item.inputDate, 'yyyy-MM-dd')}">2024-01-01</td>
              </tr>
              <tr th:if="${#lists.isEmpty(reportList)}">
                <td colspan="6" style="text-align: center;">등록된 신고가 없습니다.</td>
              </tr>
            </tbody>
          </table>

          <div class="table-footer">
            <div class="table-controls">
              <button class="control-button" id="deleteBtn">삭제</button>
            </div>

            <!-- 페이지네이션 -->
            <div class="pagination" th:if="${pagination.totalPages > 0}">
              <a th:if="${pagination.pageNum > 1}" th:href="@{/admin/report(page=${pagination.pageNum - 1}, searchType=${param.searchType}, keyword=${param.keyword})}" class="prev">&lt;</a>
              <a th:unless="${pagination.pageNum > 1}" class="prev disabled">&lt;</a>

              <a th:each="i : ${#numbers.sequence(1, pagination.totalPages)}"
                 th:href="@{/admin/report(page=${i}, searchType=${param.searchType}, keyword=${param.keyword})}"
                 th:text="${i}"
                 th:classappend="${i == pagination.pageNum} ? 'active' : ''">1</a>

              <a th:if="${pagination.pageNum < pagination.totalPages}" th:href="@{/admin/report(page=${pagination.pageNum + 1}, searchType=${param.searchType}, keyword=${param.keyword})}" class="next">&gt;</a>
              <a th:unless="${pagination.pageNum < pagination.totalPages}" class="next disabled">&gt;</a>
            </div>
          </div>
        </section>
      </main>
      
      <script src="/js/admin/script.js" defer></script>
    </div>
  </div>

  <script>
    $(function () {
      $('#resetSearch').click(function () {
        $('input[name="keyword"]').val('');
        $('#searchForm').submit();
      });

      $('.all-checkbox').click(function () {
        $('.checkbox').prop('checked', this.checked);
      });

  	 // 🔥 삭제 버튼 이벤트
      $('#deleteBtn').click(function () {
        const selected = [];
        $('.checkbox:checked').each(function () {
          selected.push($(this).data('report-num'));
        });

        if (selected.length === 0) {
          alert('삭제할 항목을 선택해주세요.');
          return;
        }

        if (confirm('정말 삭제하시겠습니까?')) {
          axios.post('/admin/report/delete', { repNums: selected })
            .then(() => {
              alert('삭제가 완료되었습니다.');
              location.reload();
            })
            .catch(() => {
              alert('삭제 중 오류가 발생했습니다.');
            });
        }
      });
      
    });
  </script>
</body>
</html>
