<th:block th:fragment="chatOverlay">
  <link rel="stylesheet" th:href="@{/css/user/components/chat.css}">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <script>
    let stompClient = null;
    let currentRoomId = null;
    let currentUser = null;
    let currentRoomSubscription = null;
    let currentOpponentUserNum = null;

    $('#chat').click(() => {
      axios.get('/chat')
        .then(res => {
          currentUser = res.data;
          $('.chat-overlay').fadeIn(300);
          $('.chat-modal').addClass('show');
          $('body').addClass('modal-open');
          loadChatRooms();
        })
        .catch(err => {
          if (err.response?.status === 401) {
            alert('로그인이 필요합니다.');
            location.href = '/login';
          }
        });
    });

    function connect() {
      if (stompClient) return;
      const socket = new SockJS('/ws-chat');
      stompClient = Stomp.over(socket);
      stompClient.debug = null;
      stompClient.connect({}, function (frame) {
        console.log('WebSocket connected');
      }, function (error) {
        console.error('WebSocket error', error);
      });
    }

    function loadChatRooms() {
      axios.get('/chat/rooms')
        .then(res => {
          const chatRooms = res.data;
          const container = document.querySelector('#chatList');
          container.innerHTML = '';
          chatRooms.forEach(room => {
            const item = `
              <div class="chat-item" 
              data-room-id="${room.chatroomNum}" 
              data-opponent-num="${room.opponentNum}" 
              data-opponent-nickname="${room.opponentNickname}" 
              data-product-name="${room.productName}"
              data-prd-num="${room.productNum}">
                <div class="chat-content">
                  <div class="chat-info">
                    <img src="${room.opponentImgPath}" class="profile-image" />
                    <span class="username">${room.opponentNickname}</span>
                    <span class="last-message-time">${room.lastMessageTime}</span>
                  </div>
                  <div class="last-message">${room.lastMessage}</div>
                </div>
                <button class="report-btn" data-user-num="${room.opponentNum}">
                  <img src="/images/report_icon.png" style="width: 20px; height: 20px;" />
                </button>
              </div>`;
            container.insertAdjacentHTML('beforeend', item);
          });

          document.querySelectorAll('.chat-item').forEach(item => {
            item.addEventListener('click', function () {
              const roomId = this.getAttribute('data-room-id');
              const opponentNum = this.getAttribute('data-opponent-num');
              const productName = this.getAttribute('data-product-name');
              currentOpponentUserNum = opponentNum;
              enterChatRoom(roomId, productName);
            });
          });

          document.querySelectorAll('.report-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
              e.stopPropagation();
              const opponent = this.getAttribute('data-user-num');
              openReportRoom(opponent);
            });
          });
        });
    }

 	// 채팅방 입장 시 상품 이름을 설정하는 부분
    function enterChatRoom(roomId, productName) {
      if (currentRoomSubscription) {
        currentRoomSubscription.unsubscribe();
      }

      document.querySelector('#chatMessages').innerHTML = '';
      currentRoomId = roomId;

      if (stompClient && stompClient.connected) {
        currentRoomSubscription = stompClient.subscribe(`/topic/chatroom/${roomId}`, function (msg) {
          const message = JSON.parse(msg.body);
          const side = String(message.userNum) === String(currentUser) ? 'right' : 'left';
          document.querySelector('#chatMessages').insertAdjacentHTML('beforeend',
            `<div class="message-${side}">${message.nickname}: ${message.content}</div>`);
        });
      } else {
        connect();
        setTimeout(() => enterChatRoom(roomId, productName), 300);
        return;
      }

      // 상대방 닉네임과 상품 이름을 올바르게 설정
      const opponentNickname = document.querySelector('.chat-item[data-room-id="' + roomId + '"]').getAttribute('data-opponent-nickname');
      document.querySelector('.chat-partner-name').textContent = productName; // 상품 이름을 설정

      document.querySelector('.chat-list').style.display = 'none';
      document.querySelector('.chat-room').style.display = 'block';
      document.querySelector('.report-room').style.display = 'none';

      loadChatRoomMessages(roomId);
    }

    function loadChatRoomMessages(roomId) {
      axios.get(`/chat/messages/${roomId}`)
        .then(res => {
          res.data.forEach(msg => {
            const side = String(msg.userNum) === String(currentUser) ? 'right' : 'left';
            document.querySelector('#chatMessages').insertAdjacentHTML('beforeend',
              `<div class="message-${side}">${msg.nickname}: ${msg.content}</div>`);
          });
        });
    }

    function sendMessage() {
      const input = document.querySelector('#chatInput');
      const content = input.value.trim();
      if (!content || !currentUser || !currentRoomId) return;

      const message = {
        userNum: currentUser,
        content: content,
        chatroomNum: Number(currentRoomId)
      };

      stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
      input.value = '';
    }

    function openReportRoom(opponentNum) {
      document.querySelector('.chat-list').style.display = 'none';
      document.querySelector('.chat-room').style.display = 'none';
      document.querySelector('.report-room').style.display = 'block';
      document.querySelector('#reportTypeSelect').value = "1";
      document.querySelector('#hiddenUserNum').value = opponentNum;
      document.querySelector('#reportTitle').value = '';
      document.querySelector('#reportContent').value = '';
   		// ✅ 현재 선택된 chat-item에서 prdNum 추출하여 hidden에 넣기
      const chatItem = document.querySelector(`.chat-item[data-opponent-num="${opponentNum}"]`);
      if (chatItem) {
        const prdNum = chatItem.getAttribute('data-prd-num'); // 또는 data-room-id로 써도 됨
        document.querySelector('#hiddenPrdNum').value = prdNum || ''; // 값이 없으면 빈 문자열로
      }
    }

    function cancelReport() {
      document.querySelector('.report-room').style.display = 'none';
      document.querySelector('.chat-list').style.display = currentRoomId ? 'none' : 'block';
      document.querySelector('.chat-room').style.display = currentRoomId ? 'block' : 'none';
    }

    function submitReport() {
      const title = document.querySelector('#reportTitle').value.trim();
      const content = document.querySelector('#reportContent').value.trim();
      const reportType = document.querySelector('#reportTypeSelect').value;
      const userNum = document.querySelector('#hiddenUserNum').value;

      if (!title || !content) {
        alert('제목과 내용을 입력해주세요.');
        return;
      }

      const payload = {
        title,
        content,
        reportType: parseInt(reportType),
        searchType: 'Y',
        userNum: userNum,
        prdNum: null
      };

      axios.post('/report', payload)
        .then(() => {
          alert('신고가 완료되었습니다.');
          cancelReport();
        }).catch(() => {
          alert('신고 처리 중 오류');
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
      connect();

      document.querySelector('#sendBtn').addEventListener('click', sendMessage);
      document.querySelector('#chatInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
      });

      document.querySelectorAll('.back-button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelector('.chat-room').style.display = 'none';
          document.querySelector('.report-room').style.display = 'none';
          document.querySelector('.chat-list').style.display = 'block';
          currentRoomId = null;
          if (currentRoomSubscription) currentRoomSubscription.unsubscribe();
        });
      });

      document.querySelector('.report-btn-inside').addEventListener('click', () => {
        openReportRoom(currentOpponentUserNum);
      });

      document.querySelector('#cancelReportBtn').addEventListener('click', cancelReport);
      document.querySelector('#submitReportBtn').addEventListener('click', submitReport);

      document.querySelector('.chat-overlay').addEventListener('click', function () {
        document.querySelector('.chat-modal').classList.remove('show');
        setTimeout(() => {
          this.style.display = 'none';
          document.querySelector('html').classList.remove('modal-open');
          document.querySelector('body').classList.remove('modal-open');
        }, 300);
      });

      document.querySelector('.close-button').addEventListener('click', () => {
        document.querySelector('.chat-modal').classList.remove('show');
        setTimeout(() => {
          document.querySelector('.chat-overlay').style.display = 'none';
          document.querySelector('html').classList.remove('modal-open');
          document.querySelector('body').classList.remove('modal-open');
        }, 300);
      });

      document.querySelector('.chat-modal').addEventListener('click', e => e.stopPropagation());
    });
    
 	// 신고 폼 제출 함수
    function submitReport() {
	  const title = document.querySelector('#reportTitle').value.trim();
	  const content = document.querySelector('#reportContent').value.trim();
	  const reportType = document.querySelector('#reportTypeSelect').value;
	  const userNum = document.querySelector('#hiddenUserNum').value;
	  const prdNum = document.querySelector('#hiddenPrdNum').value;
	
	  if (!title || !content) {
	    alert('제목과 내용을 입력해주세요.');
	    return;
	  }
	
	  // 신고 유형에 따라 userNum 또는 prdNum만 보내기
	  const payload = {
	    title: title,
	    content: content,
	    reportType: parseInt(reportType), // 1: 판매자 신고, 2: 상품 신고
	    searchType: reportType === "1" ? 'Y' : 'N', // 판매자 신고일 경우 'Y', 상품 신고일 경우 'N'
	    userNum: reportType === "1" ? userNum : null,  // 판매자 신고일 경우 userNum
	    prdNum: reportType === "2" ? prdNum : null   // 상품 신고일 경우 prdNum
	  };
	
	  // 신고 데이터를 서버로 전송
	  axios.post('/report', payload)
	    .then(() => {
	        alert('신고가 완료되었습니다.');
	        cancelReport();
	    })
	    .catch((err) => {  // err를 catch에 정의
	        console.error('Error details:', err);  // 오류를 콘솔에 출력
	        alert('신고 처리 중 오류가 발생했습니다.');
	    });
	}
  </script>

  <!-- 채팅 UI -->
  <div class="chat-overlay" style="display:none;"></div>
  <div class="chat-modal">
    <div class="chat-container">

      <!-- 헤더 -->
      <div class="chat-header">
        <h1 class="chat-title">채팅</h1>
        <button class="close-button">X</button>
      </div>

      <!-- 목록 -->
      <div class="chat-list" id="chatList"></div>

      <!-- 채팅방 -->
      <div class="chat-room" style="display:none;">
        <div class="chat-room-header">
          <button class="back-button">←</button>
          <span class="chat-partner-name">상품 이름</span>
          <button class="report-btn-inside">
            <img src="/images/report_icon.png" style="width: 20px; height: 20px;" />
          </button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
          <input type="text" id="chatInput" placeholder="메시지를 입력하세요" />
          <button id="sendBtn">전송</button>
        </div>
      </div>

      <!-- 신고방 -->
      <div class="report-room" style="display: none;">
        <div class="chat-room-header">
          <button class="back-button">←</button>
          <span>신고하기</span>
        </div>

        <form id="reportForm">
          <label for="reportTitle">제목</label>
          <input type="text" id="reportTitle" placeholder="제목 입력" />

          <label for="reportContent">내용</label>
          <textarea id="reportContent" placeholder="신고 사유 입력"></textarea>

          <label for="reportTypeSelect">신고 유형</label>
          <select id="reportTypeSelect">
            <option value="1">유저 신고</option>
            <option value="2">상품 신고</option>
          </select>

          <div class="report-btns">
            <button type="button" id="submitReportBtn">신고</button>
            <button type="button" id="cancelReportBtn">취소</button>
          </div>
        </form>

        <input type="hidden" id="hiddenUserNum" />
        <input type="hidden" id="hiddenPrdNum" />
      </div>

    </div>
  </div>
</th:block>
